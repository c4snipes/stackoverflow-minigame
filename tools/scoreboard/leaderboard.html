<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stackoverflow Skyscraper ‚Äî Leaderboard</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'VT323', monospace;
        background: #0a0a0a;
        color: #00ff41;
        padding: 0;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }

      /* CRT Screen Effects */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.15),
          rgba(0, 0, 0, 0.15) 1px,
          transparent 1px,
          transparent 2px
        );
        pointer-events: none;
        z-index: 1000;
        animation: scanline 8s linear infinite;
      }

      @keyframes scanline {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(10px);
        }
      }

      /* CRT Flicker */
      body::after {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(18, 16, 16, 0.1);
        opacity: 0;
        pointer-events: none;
        z-index: 999;
        animation: flicker 0.15s infinite;
      }

      @keyframes flicker {
        0% {
          opacity: 0.27861;
        }
        5% {
          opacity: 0.34769;
        }
        10% {
          opacity: 0.23604;
        }
        15% {
          opacity: 0.90626;
        }
        20% {
          opacity: 0.18128;
        }
        25% {
          opacity: 0.83891;
        }
        30% {
          opacity: 0.65583;
        }
        35% {
          opacity: 0.67807;
        }
        40% {
          opacity: 0.26559;
        }
        45% {
          opacity: 0.84693;
        }
        50% {
          opacity: 0.96019;
        }
        55% {
          opacity: 0.08594;
        }
        60% {
          opacity: 0.20313;
        }
        65% {
          opacity: 0.71988;
        }
        70% {
          opacity: 0.53455;
        }
        75% {
          opacity: 0.37288;
        }
        80% {
          opacity: 0.71428;
        }
        85% {
          opacity: 0.70419;
        }
        90% {
          opacity: 0.7003;
        }
        95% {
          opacity: 0.36108;
        }
        100% {
          opacity: 0.24387;
        }
      }

      .terminal {
        max-width: 1200px;
        margin: 3rem auto;
        padding: 2rem;
        position: relative;
        z-index: 1;
      }

      /* Terminal Border */
      .screen-border {
        border: 4px solid #00ff41;
        border-radius: 0;
        padding: 3rem 2.5rem;
        background: rgba(0, 0, 0, 0.8);
        box-shadow:
          inset 0 0 50px rgba(0, 255, 65, 0.1),
          0 0 20px rgba(0, 255, 65, 0.3),
          0 0 40px rgba(0, 255, 65, 0.1);
      }

      .ascii-corners {
        position: relative;
      }

      .ascii-corners::before,
      .ascii-corners::after {
        position: absolute;
        font-size: 1.5rem;
        color: #00ff41;
        line-height: 1;
      }

      .ascii-corners::before {
        content: "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê";
        top: -0.75rem;
        left: -0.5rem;
        right: -0.5rem;
        white-space: nowrap;
        overflow: hidden;
      }

      .ascii-corners::after {
        content: "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò";
        bottom: -0.75rem;
        left: -0.5rem;
        right: -0.5rem;
        white-space: nowrap;
        overflow: hidden;
      }

      header {
        text-align: center;
        margin-bottom: 3rem;
        text-transform: uppercase;
      }

      .title-art {
        font-size: clamp(1.4rem, 3.5vw, 2.2rem);
        font-weight: normal;
        line-height: 1.5;
        color: #00ff41;
        text-shadow:
          0 0 10px #00ff41,
          0 0 20px #00ff41,
          0 0 30px #00ff41;
        animation: glow 2s ease-in-out infinite alternate;
        letter-spacing: 0.05em;
        margin-bottom: 1.5rem;
      }

      @keyframes glow {
        from {
          text-shadow:
            0 0 5px #00ff41,
            0 0 10px #00ff41,
            0 0 15px #00ff41;
        }
        to {
          text-shadow:
            0 0 10px #00ff41,
            0 0 20px #00ff41,
            0 0 30px #00ff41,
            0 0 40px #00ff41;
        }
      }

      .subtitle {
        color: #00dd00;
        font-size: clamp(1rem, 2vw, 1.3rem);
        margin-bottom: 0.5rem;
        margin-top: 1rem;
      }

      .blink {
        animation: blink 1s step-start infinite;
      }

      @keyframes blink {
        50% {
          opacity: 0;
        }
      }

      .section-divider {
        margin: 3.5rem 0 2rem 0;
        text-align: center;
        color: #00ff41;
        font-size: 1.2rem;
      }

      .section-title {
        display: inline-block;
        background: #0a0a0a;
        padding: 0 1rem;
        position: relative;
        font-size: clamp(1.3rem, 2.5vw, 1.8rem);
        text-shadow: 0 0 10px #00ff41;
        letter-spacing: 0.05em;
      }

      .section-divider::before {
        content: "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê";
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        z-index: -1;
        overflow: hidden;
        white-space: nowrap;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 2rem 0;
        font-size: clamp(1rem, 2vw, 1.25rem);
        background: rgba(0, 20, 0, 0.5);
      }

      thead {
        border-bottom: 2px solid #00ff41;
      }

      th {
        padding: 1rem 0.8rem;
        text-align: left;
        color: #00ff41;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        font-weight: normal;
        border-bottom: 2px solid #00ff41;
        text-shadow: 0 0 5px #00ff41;
      }

      td {
        padding: 0.8rem 0.8rem;
        border-bottom: 1px solid #003300;
        color: #00dd00;
      }

      tbody tr {
        transition: all 0.1s ease;
      }

      tbody tr:hover {
        background: rgba(0, 255, 65, 0.1);
        box-shadow: inset 0 0 10px rgba(0, 255, 65, 0.2);
      }

      /* Rank styling */
      tbody tr:nth-child(1) td:first-child {
        color: #ffff00;
        text-shadow: 0 0 10px #ffff00;
      }

      tbody tr:nth-child(1) td:first-child::before {
        content: ">>> ";
      }

      tbody tr:nth-child(2) td:first-child {
        color: #00ffff;
        text-shadow: 0 0 10px #00ffff;
      }

      tbody tr:nth-child(2) td:first-child::before {
        content: ">>  ";
      }

      tbody tr:nth-child(3) td:first-child {
        color: #ff8800;
        text-shadow: 0 0 10px #ff8800;
      }

      tbody tr:nth-child(3) td:first-child::before {
        content: ">   ";
      }

      tbody tr:nth-child(n+4) td:first-child::before {
        content: "    ";
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #00aa00;
        font-size: 1.3rem;
      }

      .empty-state::before {
        content: "[ NO DATA RECORDED ]";
        display: block;
        font-size: 1.8rem;
        margin-bottom: 1rem;
        color: #00ff41;
        animation: blink 2s step-start infinite;
      }

      footer {
        text-align: center;
        margin-top: 3.5rem;
        padding: 1.5rem 1rem 0.5rem 1rem;
        color: #00aa00;
        font-size: 1.15rem;
        border-top: 1px solid #003300;
      }

      footer a {
        color: #00ff41;
        text-decoration: none;
        text-shadow: 0 0 5px #00ff41;
      }

      footer a:hover {
        text-decoration: underline;
        text-shadow: 0 0 10px #00ff41;
      }

      .prompt {
        color: #00ff41;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .terminal {
          margin: 1rem;
          padding: 0.5rem;
        }

        .screen-border {
          padding: 1.5rem 1rem;
        }

        .title-art {
          font-size: 1.2rem;
          line-height: 1.4;
        }

        .section-title {
          font-size: 1.2rem;
          padding: 0 0.8rem;
        }

        th, td {
          padding: 0.6rem 0.4rem;
          font-size: 0.95rem;
        }

        th:nth-child(3), td:nth-child(3),
        th:nth-child(4), td:nth-child(4) {
          display: none;
        }

        .ascii-corners::before,
        .ascii-corners::after {
          font-size: 1rem;
        }

        footer {
          font-size: 1rem;
        }
      }

      @media (max-width: 480px) {
        .screen-border {
          padding: 1rem 0.8rem;
        }

        .title-art {
          font-size: 1rem;
        }

        .section-title {
          font-size: 1rem;
        }

        table {
          font-size: 0.9rem;
        }
      }

      /* Loading animation */
      @keyframes typing {
        from {
          width: 0;
        }
      }

      .system-info {
        color: #00aa00;
        font-size: 1.05rem;
        margin-bottom: 1.5rem;
        opacity: 0.8;
      }

      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem 1rem;
        background: rgba(0, 40, 0, 0.3);
        border: 1px solid #003300;
        margin-bottom: 1.5rem;
        font-size: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #00ff41;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% {
          opacity: 1;
          box-shadow: 0 0 5px #00ff41;
        }
        50% {
          opacity: 0.5;
          box-shadow: 0 0 2px #00ff41;
        }
      }

      .refresh-btn {
        background: transparent;
        border: 1px solid #00ff41;
        color: #00ff41;
        padding: 0.4rem 1rem;
        font-family: 'VT323', monospace;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .refresh-btn:hover {
        background: rgba(0, 255, 65, 0.1);
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
      }

      .refresh-btn:active {
        transform: scale(0.95);
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 768px) {
        .status-bar {
          font-size: 0.9rem;
          padding: 0.6rem 0.8rem;
        }

        .refresh-btn {
          font-size: 1rem;
          padding: 0.3rem 0.8rem;
        }
      }

      /* Loading Spinner */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }

      .loading-overlay.active {
        opacity: 1;
        pointer-events: all;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(0, 255, 65, 0.2);
        border-top: 4px solid #00ff41;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .loading-text {
        color: #00ff41;
        font-size: 1.5rem;
        margin-top: 1rem;
        text-shadow: 0 0 10px #00ff41;
        animation: blink 1.5s ease-in-out infinite;
      }

      /* Search & Filter */
      .search-container {
        margin: 2rem 0;
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-input {
        flex: 1;
        min-width: 200px;
        background: rgba(0, 40, 0, 0.3);
        border: 1px solid #00ff41;
        color: #00ff41;
        padding: 0.6rem 1rem;
        font-family: 'VT323', monospace;
        font-size: 1.1rem;
        outline: none;
        transition: all 0.2s;
      }

      .search-input::placeholder {
        color: #00aa00;
        opacity: 0.7;
      }

      .search-input:focus {
        background: rgba(0, 60, 0, 0.5);
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
      }

      .clear-btn {
        background: transparent;
        border: 1px solid #00ff41;
        color: #00ff41;
        padding: 0.6rem 1rem;
        font-family: 'VT323', monospace;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
      }

      .clear-btn:hover {
        background: rgba(0, 255, 65, 0.1);
      }

      .no-results {
        text-align: center;
        padding: 2rem;
        color: #00aa00;
        font-size: 1.2rem;
      }

      tbody tr.hidden {
        display: none;
      }

      /* Time Filter */
      .time-filter-container {
        margin: 1.5rem 0;
        display: flex;
        gap: 1rem;
        align-items: center;
        padding: 0.8rem 1rem;
        background: rgba(0, 40, 0, 0.3);
        border: 1px solid #003300;
      }

      .time-filter-container label {
        color: #00ff41;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .time-filter-select {
        background: rgba(0, 60, 0, 0.5);
        border: 1px solid #00ff41;
        color: #00ff41;
        padding: 0.5rem 1rem;
        font-family: 'VT323', monospace;
        font-size: 1.1rem;
        cursor: pointer;
        outline: none;
        transition: all 0.2s;
      }

      .time-filter-select:hover {
        background: rgba(0, 80, 0, 0.7);
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
      }

      .time-filter-select option {
        background: #0a0a0a;
        color: #00ff41;
      }

      /* Stats Dashboard */
      .stats-dashboard {
        margin: 2rem 0;
        padding: 1.5rem;
        background: rgba(0, 40, 0, 0.3);
        border: 2px solid #00ff41;
        box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.1);
      }

      .stats-title {
        text-align: center;
        color: #00ff41;
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        text-shadow: 0 0 10px #00ff41;
        letter-spacing: 0.15em;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
      }

      .stat-card {
        background: rgba(0, 20, 0, 0.5);
        border: 1px solid #003300;
        padding: 1rem;
        text-align: center;
        transition: all 0.2s;
      }

      .stat-card:hover {
        background: rgba(0, 40, 0, 0.7);
        border-color: #00ff41;
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
      }

      .stat-label {
        color: #00aa00;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
      }

      .stat-value {
        color: #00ff41;
        font-size: 1.8rem;
        font-weight: bold;
        text-shadow: 0 0 5px #00ff41;
      }

      @media (max-width: 768px) {
        .time-filter-container {
          flex-direction: column;
          align-items: flex-start;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .stat-value {
          font-size: 1.4rem;
        }
      }

      @media (max-width: 480px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }
      }

      /* QR Code Section */
      .qr-section {
        text-align: center;
        margin-top: 2rem;
        padding: 2rem 1rem;
        border-top: 1px solid #003300;
      }

      .qr-title {
        color: #00ff41;
        font-size: 1.3rem;
        margin-bottom: 1rem;
        text-shadow: 0 0 5px #00ff41;
      }

      .qr-code {
        display: inline-block;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
      }

      .qr-code img {
        display: block;
        width: 200px;
        height: 200px;
      }

      .qr-caption {
        color: #00aa00;
        font-size: 1rem;
        margin-top: 1rem;
      }

      @media (max-width: 768px) {
        .search-container {
          flex-direction: column;
        }

        .search-input {
          width: 100%;
        }

        .qr-code img {
          width: 150px;
          height: 150px;
        }
      }
    </style>
  </head>
  <body>
    <div class="terminal">
      <div class="screen-border">
        <div class="ascii-corners">
          <header>
            <div class="system-info">
              <span class="prompt">root@flyio:~$</span> cat /data/scoreboard.db
            </div>
            <h1 class="title-art">
              ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó<br>
              ‚ïë  STACKOVERFLOW SKYSCRAPER              ‚ïë<br>
              ‚ïë  === LEADERBOARD TERMINAL ===          ‚ïë<br>
              ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            </h1>
            <p class="subtitle">
              REMOTE FEED: FLY.IO ‚Üí POST TO /scoreboard <span class="blink">‚ñÆ</span>
            </p>
          </header>

          <div class="status-bar">
            <div class="status-item">
              <span class="status-indicator"></span>
              <span>LIVE</span>
              <span id="last-update">Last updated: Just now</span>
            </div>
            <button class="refresh-btn" onclick="refreshLeaderboard()">‚Üª REFRESH</button>
          </div>

          <div class="search-container">
            <input
              type="text"
              id="search-input"
              class="search-input"
              placeholder="Search by initials (e.g., ACE, MVP...)..."
              oninput="filterTables()"
            />
            <button class="clear-btn" onclick="clearSearch()">‚úï CLEAR</button>
          </div>

          <div class="time-filter-container">
            <label for="time-filter">Time Range:</label>
            <select id="time-filter" class="time-filter-select" onchange="changeTimeFilter()">
              <option value="">All Time</option>
              <option value="today">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>

          <div class="stats-dashboard" id="stats-dashboard">
            <div class="stats-title">[ GLOBAL STATISTICS ]</div>
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Total Players</div>
                <div class="stat-value" id="stat-total-players">-</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Runs</div>
                <div class="stat-value" id="stat-total-runs">-</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Average Level</div>
                <div class="stat-value" id="stat-avg-level">-</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Record Level</div>
                <div class="stat-value" id="stat-highest-level">-</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Fastest Time</div>
                <div class="stat-value" id="stat-fastest-time">-</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">üèÜ Top Player</div>
                <div class="stat-value" id="stat-top-player">-</div>
              </div>
            </div>
          </div>

          <div class="section-divider">
            <span class="section-title">[ &nbsp;TOP LEVELS&nbsp; ]</span>
          </div>
          {{TOP_LEVELS}}

          <div class="section-divider">
            <span class="section-title">[ &nbsp;FASTEST RUNS&nbsp; ]</span>
          </div>
          {{FASTEST_RUNS}}

          <div class="qr-section">
            <div class="qr-title">[ SCAN TO VIEW REPO ]</div>
            <div class="qr-code">
              <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://github.com/c4snipes/stackoverflow-minigame" alt="QR Code to GitHub Repo" />
            </div>
            <div class="qr-caption">Scan with your phone to visit the repository</div>
          </div>

          <footer>
            <p>
              <span class="prompt">></span> SOURCE:
              <a href="https://github.com/c4snipes/stackoverflow-minigame">github.com/c4snipes/stackoverflow-minigame</a>
            </p>
          </footer>
        </div>
      </div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
      <div style="text-align: center;">
        <div class="spinner"></div>
        <div class="loading-text">LOADING...</div>
      </div>
    </div>

    <script>
      let autoRefreshInterval;
      const AUTO_REFRESH_SECONDS = 30;

      // Format time ago
      function timeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);

        if (seconds < 10) return 'Just now';
        if (seconds < 60) return `${seconds} seconds ago`;

        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;

        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;

        const days = Math.floor(hours / 24);
        return `${days} day${days > 1 ? 's' : ''} ago`;
      }

      // Update timestamp display
      function updateTimestamp() {
        const lastUpdate = localStorage.getItem('lastLeaderboardUpdate');
        const timestamp = lastUpdate ? parseInt(lastUpdate) : Date.now();
        const element = document.getElementById('last-update');
        if (element) {
          element.textContent = `Last updated: ${timeAgo(timestamp)}`;
        }
      }

      // Show/hide loading spinner
      function showLoading() {
        document.getElementById('loading-overlay').classList.add('active');
      }

      function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
      }

      // Refresh leaderboard data with optional time filter
      async function refreshLeaderboard(since = null) {
        showLoading();
        try {
          const url = since ? `/scoreboard?since=${since}` : '/scoreboard';
          const response = await fetch(url);
          if (!response.ok) throw new Error('Failed to fetch');

          const data = await response.json();

          // Update top levels table
          updateTable('top-levels-body', data.topLevels, (entry, rank) => `
            <tr class="fade-in">
              <td>${rank}</td>
              <td>${entry.initials}</td>
              <td>${entry.level}</td>
              <td>${formatDuration(entry.runTimeTicks)}</td>
            </tr>
          `);

          // Update fastest runs table
          updateTable('fastest-runs-body', data.fastestRuns, (entry, rank) => `
            <tr class="fade-in">
              <td>${rank}</td>
              <td>${entry.initials}</td>
              <td>${formatDuration(entry.runTimeTicks)}</td>
              <td>${entry.level}</td>
            </tr>
          `);

          // Update global stats
          if (data.stats) {
            updateStats(data.stats);
          }

          // Update timestamp
          localStorage.setItem('lastLeaderboardUpdate', Date.now().toString());
          updateTimestamp();

          // Reapply search filter if active
          const searchInput = document.getElementById('search-input');
          if (searchInput && searchInput.value.trim()) {
            filterTables();
          }

        } catch (error) {
          console.error('Failed to refresh leaderboard:', error);
        } finally {
          hideLoading();
        }
      }

      // Update stats dashboard
      function updateStats(stats) {
        document.getElementById('stat-total-players').textContent = stats.totalPlayers || 0;
        document.getElementById('stat-total-runs').textContent = stats.totalRuns || 0;
        document.getElementById('stat-avg-level').textContent = stats.averageLevel || 0;
        document.getElementById('stat-highest-level').textContent = stats.highestLevel || 0;
        document.getElementById('stat-fastest-time').textContent =
          stats.fastestTimeTicks ? formatDuration(stats.fastestTimeTicks) : '-';
        document.getElementById('stat-top-player').textContent = stats.topPlayer || 'N/A';
      }

      // Handle time filter change
      function changeTimeFilter() {
        const select = document.getElementById('time-filter');
        const since = select.value;
        refreshLeaderboard(since || null);
      }

      // Format duration from ticks
      function formatDuration(ticks) {
        try {
          const totalSeconds = parseFloat(ticks) / 10_000_000;
          const minutes = Math.floor(totalSeconds / 60);
          const seconds = totalSeconds % 60;
          return `${String(minutes).padStart(2, '0')}:${seconds.toFixed(3).padStart(6, '0')}`;
        } catch {
          return '00:00.000';
        }
      }

      // Update table helper
      function updateTable(tableId, data, rowTemplate) {
        const tbody = document.getElementById(tableId);
        if (!tbody || !data || data.length === 0) return;

        tbody.innerHTML = data.map((entry, index) => rowTemplate(entry, index + 1)).join('');
      }

      // Search and filter functionality
      function filterTables() {
        const searchTerm = document.getElementById('search-input').value.trim().toUpperCase();

        // Filter both tables
        filterTable('top-levels-body', searchTerm);
        filterTable('fastest-runs-body', searchTerm);
      }

      function filterTable(tableId, searchTerm) {
        const tbody = document.getElementById(tableId);
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach(row => {
          const initialsCell = row.cells[1]; // Initials are in the second column
          if (!initialsCell) return;

          const initials = initialsCell.textContent.trim().toUpperCase();

          if (!searchTerm || initials.includes(searchTerm)) {
            row.classList.remove('hidden');
            visibleCount++;
          } else {
            row.classList.add('hidden');
          }
        });

        // Update rank numbers for visible rows
        updateRanks(tbody);
      }

      function updateRanks(tbody) {
        const visibleRows = tbody.querySelectorAll('tr:not(.hidden)');
        visibleRows.forEach((row, index) => {
          const rankCell = row.cells[0];
          if (rankCell) {
            rankCell.textContent = index + 1;
          }
        });
      }

      function clearSearch() {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
          searchInput.value = '';
          filterTables();
        }
      }

      // Page visibility detection to pause auto-refresh
      function handleVisibilityChange() {
        if (document.hidden) {
          // Page is hidden - pause auto-refresh
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('[Leaderboard] Auto-refresh paused (page hidden)');
          }
        } else {
          // Page is visible - resume auto-refresh
          if (!autoRefreshInterval) {
            autoRefreshInterval = setInterval(refreshLeaderboard, AUTO_REFRESH_SECONDS * 1000);
            console.log('[Leaderboard] Auto-refresh resumed (page visible)');
            // Refresh immediately when page becomes visible
            refreshLeaderboard();
          }
        }
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        // Set initial timestamp
        localStorage.setItem('lastLeaderboardUpdate', Date.now().toString());

        // Update timestamp display every second
        setInterval(updateTimestamp, 1000);

        // Auto-refresh every 30 seconds
        autoRefreshInterval = setInterval(refreshLeaderboard, AUTO_REFRESH_SECONDS * 1000);

        // Listen for page visibility changes
        document.addEventListener('visibilitychange', handleVisibilityChange);

        console.log(`[Leaderboard] Auto-refresh enabled (every ${AUTO_REFRESH_SECONDS}s)`);
        console.log('[Leaderboard] Page visibility detection enabled (saves bandwidth when hidden)');
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
      });
    </script>
  </body>
</html>
