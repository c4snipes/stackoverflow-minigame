<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stackoverflow Skyscraper ‚Äî Leaderboard</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'VT323', monospace;
        background: #000;
        color: #0f0;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
        line-height: 1.4;
      }

      /* Retro CRT scanlines - subtle */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
          0deg,
          rgba(0, 0, 0, 0.1),
          rgba(0, 0, 0, 0.1) 1px,
          transparent 1px,
          transparent 2px
        );
        pointer-events: none;
        z-index: 999;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Terminal window effect */
      .terminal-window {
        background: #0a0a0a;
        border: 2px solid #0a0;
        margin: 20px 0;
        position: relative;
      }

      /* Terminal title bar */
      .terminal-header {
        background: #0d260d;
        border-bottom: 1px solid #0a0;
        padding: 8px 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .terminal-dots {
        display: flex;
        gap: 6px;
      }

      .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid #040;
      }

      .dot.red { background: #400; }
      .dot.yellow { background: #440; }
      .dot.green { background: #040; }

      .terminal-title {
        color: #0a0;
        font-size: 1.1rem;
        margin-left: 10px;
        text-shadow: none;
      }

      .terminal-content {
        padding: 25px;
      }

      /* Header styling */
      header {
        margin-bottom: 25px;
      }

      .prompt-line {
        color: #0a0;
        font-size: 1.05rem;
        margin-bottom: 15px;
      }

      .prompt-char {
        color: #0d0;
        text-shadow: none;
      }

      .ascii-title {
        font-size: clamp(1.3rem, 2.8vw, 2rem);
        color: #0c0;
        text-shadow: none;
        margin-bottom: 10px;
        line-height: 1.3;
        letter-spacing: 0.02em;
      }

      .subtitle {
        color: #0d0;
        font-size: clamp(0.95rem, 1.8vw, 1.15rem);
        margin-top: 10px;
      }

      .cursor-blink {
        animation: blink 1s step-start infinite;
      }

      @keyframes blink {
        50% { opacity: 0; }
      }

      /* Status bar */
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: rgba(0, 50, 0, 0.3);
        border: 1px solid #040;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
      }

      .pulse-dot {
        width: 8px;
        height: 8px;
        background: #0c0;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      .btn {
        background: transparent;
        border: 1px solid #0a0;
        color: #0c0;
        padding: 6px 15px;
        font-family: 'VT323', monospace;
        font-size: 1.05rem;
        cursor: pointer;
        transition: all 0.2s;
        text-transform: uppercase;
      }

      .btn:hover {
        background: rgba(0, 100, 0, 0.2);
        border-color: #0c0;
      }

      .btn:active {
        transform: translateY(0);
      }

      /* Search & Filter */
      .controls-row {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .search-box {
        flex: 1;
        min-width: 250px;
        background: rgba(0, 40, 0, 0.3);
        border: 1px solid #0a0;
        color: #0c0;
        padding: 8px 12px;
        font-family: 'VT323', monospace;
        font-size: 1.05rem;
        outline: none;
        transition: all 0.2s;
      }

      .search-box::placeholder {
        color: #070;
      }

      .search-box:focus {
        background: rgba(0, 60, 0, 0.4);
        border-color: #0c0;
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(0, 40, 0, 0.3);
        border: 1px solid #040;
        padding: 8px 12px;
      }

      .filter-label {
        color: #0c0;
        font-size: 1.05rem;
        white-space: nowrap;
      }

      .filter-select {
        background: rgba(0, 60, 0, 0.5);
        border: 1px solid #0a0;
        color: #0c0;
        padding: 6px 12px;
        font-family: 'VT323', monospace;
        font-size: 1.05rem;
        cursor: pointer;
        outline: none;
      }

      .filter-select option {
        background: #000;
      }

      /* Stats Dashboard */
      .stats-panel {
        margin: 25px 0;
        padding: 20px;
        background: rgba(0, 40, 0, 0.2);
        border: 1px solid #0a0;
      }

      .stats-heading {
        text-align: center;
        color: #0c0;
        font-size: 1.4rem;
        margin-bottom: 20px;
        text-shadow: none;
        letter-spacing: 0.1em;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 15px;
      }

      .stat-box {
        background: rgba(0, 30, 0, 0.4);
        border: 1px solid #040;
        padding: 15px;
        text-align: center;
        transition: all 0.2s;
      }

      .stat-box:hover {
        background: rgba(0, 50, 0, 0.5);
        border-color: #0a0;
      }

      .stat-label {
        color: #0a0;
        font-size: 0.95rem;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .stat-number {
        color: #0c0;
        font-size: 1.7rem;
        text-shadow: none;
        font-weight: bold;
      }

      /* Section dividers */
      .section-break {
        margin: 30px 0 20px 0;
        text-align: center;
        position: relative;
      }

      .section-label {
        display: inline-block;
        background: #0a0a0a;
        padding: 0 15px;
        color: #0c0;
        font-size: 1.3rem;
        text-shadow: none;
        letter-spacing: 0.08em;
        position: relative;
        z-index: 1;
      }

      .section-break::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 1px;
        background: #040;
      }

      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        font-size: 1.15rem;
      }

      thead {
        border-bottom: 1px solid #0a0;
      }

      th {
        padding: 12px 10px;
        text-align: left;
        color: #0c0;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-weight: normal;
        text-shadow: none;
      }

      td {
        padding: 10px 10px;
        border-bottom: 1px solid #040;
        color: #0d0;
      }

      tbody tr {
        transition: all 0.15s;
      }

      tbody tr:hover {
        background: rgba(0, 255, 0, 0.08);
      }

      tbody tr.hidden {
        display: none;
      }

      /* Top 3 ranks styling */
      tbody tr:nth-child(1) td:first-child {
        color: #ff0;
        text-shadow: 0 0 10px #ff0;
        font-size: 1.25rem;
      }

      tbody tr:nth-child(1) td:first-child::before {
        content: "üëë ";
      }

      tbody tr:nth-child(2) td:first-child {
        color: #0ff;
        text-shadow: 0 0 10px #0ff;
      }

      tbody tr:nth-child(2) td:first-child::before {
        content: "ü•à ";
      }

      tbody tr:nth-child(3) td:first-child {
        color: #f80;
        text-shadow: 0 0 10px #f80;
      }

      tbody tr:nth-child(3) td:first-child::before {
        content: "ü•â ";
      }

      /* Empty state */
      .empty-message {
        text-align: center;
        padding: 40px 20px;
        color: #0a0;
        font-size: 1.2rem;
      }

      .empty-message::before {
        content: "[ NO RECORDS FOUND ]";
        display: block;
        font-size: 1.6rem;
        margin-bottom: 15px;
        color: #0c0;
        animation: blink 2s step-start infinite;
      }

      /* QR Code section */
      .qr-section {
        text-align: center;
        margin-top: 30px;
        padding: 25px 15px;
        border-top: 1px solid #040;
      }

      .qr-heading {
        color: #0c0;
        font-size: 1.25rem;
        margin-bottom: 15px;
        text-shadow: none;
      }

      .qr-wrapper {
        display: inline-block;
        padding: 12px;
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      }

      .qr-wrapper img {
        display: block;
        width: 180px;
        height: 180px;
      }

      .qr-text {
        color: #0a0;
        font-size: 1rem;
        margin-top: 12px;
      }

      /* Footer */
      footer {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        color: #0a0;
        font-size: 1.1rem;
        border-top: 1px solid #040;
      }

      footer a {
        color: #0c0;
        text-decoration: none;
        text-shadow: none;
        transition: all 0.2s;
      }

      footer a:hover {
        text-decoration: underline;
        color: #0f0;
      }

      /* Loading overlay */
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }

      .loading-screen.active {
        opacity: 1;
        pointer-events: all;
      }

      .spinner-ring {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(0, 255, 0, 0.2);
        border-top: 4px solid #0f0;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .loading-label {
        color: #0c0;
        font-size: 1.4rem;
        margin-top: 15px;
        text-shadow: none;
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .stats-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .terminal-window {
          margin: 10px 0;
        }

        .terminal-content {
          padding: 15px;
        }

        .ascii-title {
          font-size: 1.2rem;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .stat-number {
          font-size: 1.4rem;
        }

        th, td {
          padding: 8px 6px;
          font-size: 1rem;
        }

        /* Hide some columns on mobile */
        th:nth-child(3), td:nth-child(3),
        th:nth-child(4), td:nth-child(4) {
          display: none;
        }

        .controls-row {
          flex-direction: column;
        }

        .search-box {
          width: 100%;
        }

        .qr-wrapper img {
          width: 140px;
          height: 140px;
        }
      }

      @media (max-width: 480px) {
        .terminal-content {
          padding: 10px;
        }

        .ascii-title {
          font-size: 1rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        table {
          font-size: 0.95rem;
        }
      }

      /* Fade-in animation */
      .fade-in {
        animation: fadeIn 0.4s ease-in;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="terminal-window">
        <div class="terminal-header">
          <div class="terminal-dots">
            <div class="dot red"></div>
            <div class="dot yellow"></div>
            <div class="dot green"></div>
          </div>
          <div class="terminal-title">stackoverflow-leaderboard.db</div>
        </div>

        <div class="terminal-content">
          <header>
            <div class="prompt-line">
              <span class="prompt-char">root@flyio</span>:<span class="prompt-char">~</span>$ sqlite3 scoreboard.db "SELECT * FROM scoreboard ORDER BY level DESC;"
            </div>
            <div class="ascii-title">
              ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó<br>
              ‚ïë  STACKOVERFLOW SKYSCRAPER LEADERBOARD   ‚ïë<br>
              ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
            </div>
            <p class="subtitle">
              REALTIME FEED: FLY.IO DEPLOYMENT <span class="cursor-blink">‚ñÆ</span>
            </p>
          </header>

          <div class="status-bar">
            <div class="status-item">
              <span class="pulse-dot"></span>
              <span>LIVE</span>
              <span id="last-update">Updated just now</span>
            </div>
            <button class="btn" onclick="refreshLeaderboard()">‚Üª REFRESH</button>
          </div>

          <div class="controls-row">
            <input
              type="text"
              id="search-input"
              class="search-box"
              placeholder="üîç Search by initials..."
              oninput="filterTables()"
            />
            <div class="filter-group">
              <label class="filter-label" for="time-filter">TIME RANGE:</label>
              <select id="time-filter" class="filter-select" onchange="changeTimeFilter()">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
              </select>
            </div>
            <button class="btn" onclick="clearSearch()">‚úï CLEAR</button>
          </div>

          <div class="stats-panel">
            <div class="stats-heading">[ GLOBAL STATISTICS ]</div>
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-label">Total Players</div>
                <div class="stat-number" id="stat-total-players">-</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Total Runs</div>
                <div class="stat-number" id="stat-total-runs">-</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Avg Level</div>
                <div class="stat-number" id="stat-avg-level">-</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Record Level</div>
                <div class="stat-number" id="stat-highest-level">-</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">Fastest Time</div>
                <div class="stat-number" id="stat-fastest-time">-</div>
              </div>
              <div class="stat-box">
                <div class="stat-label">üëë Top Player</div>
                <div class="stat-number" id="stat-top-player">-</div>
              </div>
            </div>
          </div>

          <div class="section-break">
            <span class="section-label">‚ñ∏ TOP LEVELS</span>
          </div>
          {{TOP_LEVELS}}

          <div class="section-break">
            <span class="section-label">‚ñ∏ FASTEST RUNS</span>
          </div>
          {{FASTEST_RUNS}}

          <div class="qr-section">
            <div class="qr-heading">[ SCAN FOR SOURCE CODE ]</div>
            <div class="qr-wrapper">
              <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=https://github.com/c4snipes/stackoverflow-minigame" alt="QR Code" />
            </div>
          </div>

          <footer>
            <p>
              <span class="prompt-char">&gt;</span> SOURCE:
              <a href="https://github.com/c4snipes/stackoverflow-minigame">github.com/c4snipes/stackoverflow-minigame</a>
            </p>
          </footer>
        </div>
      </div>
    </div>

    <div class="loading-screen" id="loading-overlay">
      <div style="text-align: center;">
        <div class="spinner-ring"></div>
        <div class="loading-label">LOADING...</div>
      </div>
    </div>

    <script>
      let autoRefreshInterval;
      const AUTO_REFRESH_SECONDS = 30;

      function timeAgo(timestamp) {
        const seconds = Math.floor((Date.now() - timestamp) / 1000);
        if (seconds < 10) return 'just now';
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;
        const days = Math.floor(hours / 24);
        return `${days}d ago`;
      }

      function updateTimestamp() {
        const lastUpdate = localStorage.getItem('lastLeaderboardUpdate');
        const timestamp = lastUpdate ? parseInt(lastUpdate) : Date.now();
        const element = document.getElementById('last-update');
        if (element) {
          element.textContent = `Updated ${timeAgo(timestamp)}`;
        }
      }

      function showLoading() {
        document.getElementById('loading-overlay').classList.add('active');
      }

      function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
      }

      async function refreshLeaderboard(since = null) {
        showLoading();

        // Abort any pending requests
        if (window.pendingRequest) {
          window.pendingRequest.abort();
        }

        const controller = new AbortController();
        window.pendingRequest = controller;

        try {
          const url = since ? `/scoreboard?since=${since}` : '/scoreboard';
          const response = await fetch(url, { signal: controller.signal });
          if (!response.ok) throw new Error('Failed to fetch');

          const data = await response.json();

          // Clear reference after successful fetch
          window.pendingRequest = null;

          updateTable('top-levels-body', data.topLevels, (entry, rank) => `
            <tr class="fade-in">
              <td>${rank}</td>
              <td>${entry.initials}</td>
              <td>${entry.level}</td>
              <td>${formatDuration(entry.runTimeTicks)}</td>
            </tr>
          `);

          updateTable('fastest-runs-body', data.fastestRuns, (entry, rank) => `
            <tr class="fade-in">
              <td>${rank}</td>
              <td>${entry.initials}</td>
              <td>${formatDuration(entry.runTimeTicks)}</td>
              <td>${entry.level}</td>
            </tr>
          `);

          if (data.stats) {
            updateStats(data.stats);
          }

          localStorage.setItem('lastLeaderboardUpdate', Date.now().toString());
          updateTimestamp();

          const searchInput = document.getElementById('search-input');
          if (searchInput && searchInput.value.trim()) {
            filterTables();
          }

        } catch (error) {
          if (error.name !== 'AbortError') {
            console.error('Failed to refresh leaderboard:', error);
          }
          window.pendingRequest = null;
        } finally {
          hideLoading();
        }
      }

      function updateStats(stats) {
        document.getElementById('stat-total-players').textContent = stats.totalPlayers || 0;
        document.getElementById('stat-total-runs').textContent = stats.totalRuns || 0;
        document.getElementById('stat-avg-level').textContent = stats.averageLevel || 0;
        document.getElementById('stat-highest-level').textContent = stats.highestLevel || 0;
        document.getElementById('stat-fastest-time').textContent =
          stats.fastestTimeTicks ? formatDuration(stats.fastestTimeTicks) : '-';
        document.getElementById('stat-top-player').textContent = stats.topPlayer || 'N/A';
      }

      function changeTimeFilter() {
        const select = document.getElementById('time-filter');
        const since = select.value;
        refreshLeaderboard(since || null);
      }

      function formatDuration(ticks) {
        try {
          const totalSeconds = parseFloat(ticks) / 10_000_000;
          const minutes = Math.floor(totalSeconds / 60);
          const seconds = totalSeconds % 60;
          return `${String(minutes).padStart(2, '0')}:${seconds.toFixed(3).padStart(6, '0')}`;
        } catch {
          return '00:00.000';
        }
      }

      function updateTable(tableId, data, rowTemplate) {
        const tbody = document.getElementById(tableId);
        if (!tbody) return;

        // Clear existing content and remove all event listeners
        while (tbody.firstChild) {
          tbody.removeChild(tbody.firstChild);
        }

        if (!data || data.length === 0) return;

        // Create document fragment for efficient DOM updates
        const fragment = document.createDocumentFragment();
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = data.map((entry, index) => rowTemplate(entry, index + 1)).join('');

        // Move nodes from temp div to fragment
        while (tempDiv.firstChild) {
          fragment.appendChild(tempDiv.firstChild);
        }

        tbody.appendChild(fragment);
      }

      function filterTables() {
        const searchTerm = document.getElementById('search-input').value.trim().toUpperCase();
        filterTable('top-levels-body', searchTerm);
        filterTable('fastest-runs-body', searchTerm);
      }

      function filterTable(tableId, searchTerm) {
        const tbody = document.getElementById(tableId);
        if (!tbody) return;

        const rows = tbody.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach(row => {
          const initialsCell = row.cells[1];
          if (!initialsCell) return;

          const initials = initialsCell.textContent.trim().toUpperCase();

          if (!searchTerm || initials.includes(searchTerm)) {
            row.classList.remove('hidden');
            visibleCount++;
          } else {
            row.classList.add('hidden');
          }
        });

        updateRanks(tbody);
      }

      function updateRanks(tbody) {
        const visibleRows = tbody.querySelectorAll('tr:not(.hidden)');
        visibleRows.forEach((row, index) => {
          const rankCell = row.cells[0];
          if (rankCell) {
            rankCell.textContent = index + 1;
          }
        });
      }

      function clearSearch() {
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
          searchInput.value = '';
          filterTables();
        }
      }

      function handleVisibilityChange() {
        if (document.hidden) {
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
          }
        } else {
          if (!autoRefreshInterval) {
            autoRefreshInterval = setInterval(refreshLeaderboard, AUTO_REFRESH_SECONDS * 1000);
            refreshLeaderboard();
          }
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        // Clean up old localStorage entries (keep only last update time)
        const keysToKeep = ['lastLeaderboardUpdate'];
        for (let i = localStorage.length - 1; i >= 0; i--) {
          const key = localStorage.key(i);
          if (key && !keysToKeep.includes(key) && key.startsWith('leaderboard')) {
            localStorage.removeItem(key);
          }
        }

        localStorage.setItem('lastLeaderboardUpdate', Date.now().toString());
        setInterval(updateTimestamp, 1000);
        autoRefreshInterval = setInterval(refreshLeaderboard, AUTO_REFRESH_SECONDS * 1000);
        document.addEventListener('visibilitychange', handleVisibilityChange);
      });

      window.addEventListener('beforeunload', () => {
        // Clear all timers
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }

        // Abort any pending requests
        if (window.pendingRequest) {
          window.pendingRequest.abort();
          window.pendingRequest = null;
        }

        // Clean up event listeners
        document.removeEventListener('visibilitychange', handleVisibilityChange);
      });
    </script>
  </body>
</html>
